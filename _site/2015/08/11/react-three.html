<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
<!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/ie.html"><![endif]-->

<title>React从入门到上手三部曲(3) | 临水照影的博客</title>
<meta name="author" content="临水照影的博客">

  <meta name="keywords" content="学习资料，程序语言">




<link rel="shortcut icon" href="http://img.haoqiao.me/avatar639D58E2-E732-4FF9-8E05-724717DFEF1F.png" />

<link rel="stylesheet" type="text/css" href="/assets/css/style.css">

<link href="/pages/rss.xml" rel="alternate" title="临水照影的博客" type="application/atom+xml">
  </head>
  <body>
    <aside id="sidebar">
  <nav id="tags">
    <a href="/index.html" id="avatar" style="background-image:url(http://img.haoqiao.me/avatar639D58E2-E732-4FF9-8E05-724717DFEF1F.png)"></a>

    <ul id="tags__ul">
      <li id="pl__all" class="tags__li tags-btn active">所有文章</li>
       
        <li id="技术" class="tags__li tags-btn">技术</li>
       
        <li id="翻译" class="tags__li tags-btn">翻译</li>
       
        <li id="读书" class="tags__li tags-btn">读书</li>
      
    </ul>

    <div id="tags__bottom">
      <a href="mailto:4799109@qq.com" id="icon-email" class="tags-btn fontello"></a>
      <a href="/pages/rss.xml" id="icon-feed" class="tags-btn fontello"></a>
    </div>
  </nav> <!-- end #tags -->

  <div id="posts-list">
    <form action="" id="search-form">
      <a href="/index.html" id="mobile-avatar" style="background-image:url(http://img.haoqiao.me/avatar639D58E2-E732-4FF9-8E05-724717DFEF1F.png)"></a>
      <!-- NOTE: input field is disabled by default -->
      <input id="search-input" type="text" placeholder="Search..." disabled >
    </form>

    <nav id="pl__container">
    
      <a class="翻译 pl__all" href="/2015/08/28/translate%20thirteen.html"><span class="pl__circle"></span><span class="pl__title">CSS-Only Raindrops on Window Effect (创建纯css雨滴窗效果）</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="翻译 pl__all" href="/2015/08/27/translate%20twelve.html"><span class="pl__circle"></span><span class="pl__title">Animated line drawing in SVG (创建svg线条动画）</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="翻译 pl__all" href="/2015/08/26/translate%20eleven.html"><span class="pl__circle"></span><span class="pl__title">Graphical Text Effects (CSS VS SVG:图像文字效果）</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="翻译 pl__all" href="/2015/08/25/translate%20nine.html"><span class="pl__circle"></span><span class="pl__title">A Content-switching Component Built 3 Ways (三种方式制作内容切换页面组件）</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="翻译 pl__all" href="/2015/08/24/translate%20eight.html"><span class="pl__circle"></span><span class="pl__title">Demystifying Closures, Callbacks and IIFEs (揭秘javascript的闭包，回调，IIFEs）</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="读书 pl__all" href="/2015/08/24/book-list-of-2015.html"><span class="pl__circle"></span><span class="pl__title">2015阅读书单</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="翻译 pl__all" href="/2015/08/23/translate%20seven.html"><span class="pl__circle"></span><span class="pl__title">Responsive Typography With Sass Maps (通过sass地图来打造响应式印刷）</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="翻译 pl__all" href="/2015/08/22/translate%20six.html"><span class="pl__circle"></span><span class="pl__title">Thinking Outside the DOM (Dom之外的思考，数据采集和校验）</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="翻译 pl__all" href="/2015/08/21/translate%20five.html"><span class="pl__circle"></span><span class="pl__title">Building A Circular Navigation with CSS Clip Paths (用CSS路径裁剪遮罩制作环形导航）</span><span class="pl__date">Aug 2015</span></a>
    
      <a class=" pl__all" href="/2015/08/21/sprite-scrollmagic.html"><span class="pl__circle"></span><span class="pl__title">Sprite动画与ScrollMagic的使用</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="翻译 pl__all" href="/2015/08/20/translate%20three.html"><span class="pl__circle"></span><span class="pl__title">Creating Autocomplete datalist Controls (创建自动完成的DataList控件）</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="翻译 pl__all" href="/2015/08/20/translate%20four.html"><span class="pl__circle"></span><span class="pl__title">Responsive Sprite Animations with ImageMagick and GreenSock (用ImageMagick 和 GreenSock 制作响应式的雪碧图动画）</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="翻译 pl__all" href="/2015/08/19/translate%20two.html"><span class="pl__circle"></span><span class="pl__title">Create Text Filling with Water Effect（创建水波纹效果文字）</span><span class="pl__date">Aug 2015</span></a>
    
      <a class=" pl__all" href="/2015/08/17/nodejs-express-vue.html"><span class="pl__circle"></span><span class="pl__title">Node.js + Express + Vue.js 自动化开发环境部署</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="技术 pl__all" href="/2015/08/17/Gulp-task.md.html"><span class="pl__circle"></span><span class="pl__title">Gulp打造前端项目自动化构建流程环境</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="翻译 pl__all" href="/2015/08/16/translate%20one.html"><span class="pl__circle"></span><span class="pl__title">译文-React’s diff algorithm（React diff算法）</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="技术 pl__all" href="/2015/08/16/react-comments.html"><span class="pl__circle"></span><span class="pl__title">Node.js + React.js 开发评论插件系统</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="技术 pl__all" href="/2015/08/11/react-three.html"><span class="pl__circle"></span><span class="pl__title">React从入门到上手三部曲(3)</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="技术 pl__all" href="/2015/08/10/react-two.html"><span class="pl__circle"></span><span class="pl__title">React从入门到上手三部曲(2)</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="技术 pl__all" href="/2015/08/09/build-nodejs-react.html"><span class="pl__circle"></span><span class="pl__title">建立Node.js+Express4.x+React+Gulp的开发环境</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="技术 pl__all" href="/2015/08/08/react-one.html"><span class="pl__circle"></span><span class="pl__title">React从入门到上手三部曲</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="技术 pl__all" href="/2015/08/08/language%20learning%20website.html"><span class="pl__circle"></span><span class="pl__title">学习资料第一波</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="技术 pl__all" href="/2015/08/05/bushu.html"><span class="pl__circle"></span><span class="pl__title">Node.js 伪部署</span><span class="pl__date">Aug 2015</span></a>
    
      <a class="技术 pl__all" href="/2015/08/03/Fitness.html"><span class="pl__circle"></span><span class="pl__title">个人健身系统从零开始(Node.js开发)</span><span class="pl__date">Aug 2015</span></a>
    
    </nav>
  </div> <!-- end #posts-list -->
</aside> <!-- end #sidebar -->
    <div id="post">
      <div id="pjax">
        <article id="post__content">
 
  <h1 id="post__title" data-identifier="20150811">React从入门到上手三部曲(3)</h1>
  <h2 id="section">前言</h2>
<p>三部曲想想应该是连贯的，因此承接上期，我们把整个包括Node.js的部分也讲述一下，可能已经不是正常的纯React教程了（似乎第二期就有点偏了。）。不过个人认为项目驱动的教程更适合入门吧。o(≧v≦)o~</p>

<h2 id="section-1">正文</h2>
<p>上期讲到数据的传递，我们提到props和state，如果是组件创建前自己去获取的数据应该放到哪呢？答案是state,因为自动获取的数据是变化的。props应该是一开始就不变的。<br />
我们来看正式项目中的newsComponent.jsx和newsitem.jsx里的内容。<br />
首先是 newsComponent.jsx里的内容</p>

<pre><code>getInitialState: function() {
  return {
     data : [{"title":"欢迎使用定制版每日资讯","href":"haoqaio.me"},{"title":"By 临水照		  影","href":"haoqiao.me"}]
  };
},
componentDidMount: function() {
  $.post("/getData" , {url:this.props.url}, function(result) {
  	var list = result;
  	if (this.isMounted()) {
  	  this.setState({
  	    data:JSON.parse(result)
  	  });
 	 }
   }.bind(this));
},
render: function() {
	var url = this.props.url;
	var component_style = "portlet box " + this.props.component_style;
	var item_style = this.props.item_style;
		console.log(this.state.data);
    var datas = this.state.data;
	if(datas){
		var NewsItems = datas.map(function(Item) {
        return &lt;NewsItem item_style={item_style} key={Item.id} title={Item.title} href={Item.href}/&gt;
 });
 }

return (
		&lt;div className={component_style}&gt;
			&lt;div className="portlet-title"&gt;
				&lt;div className="caption"&gt;
				  &lt;i className="fa fa-cogs"&gt;&lt;/i&gt;
				  今日资讯 From {url}
				&lt;/div&gt;
				&lt;div class="tools"&gt;
					&lt;a href="javascript:;" data-original-title="" title="" class="expand"&gt;&lt;/a&gt;
				&lt;/div&gt;
			&lt;/div&gt;
			&lt;div className="portlet-body"&gt;
				  {NewsItems}
			&lt;/div&gt;
		&lt;/div&gt;  
      );
}
</code></pre>

<p>看到我们可以看到比教程2里的演示这里多了不少东西，我们一一来分析。<br />
首先是分析我们设计的思路，我们是想要在props里面传过来url，然后组件在渲染之前自己拿到数据，然后再渲染。这就涉及到组件的生命周期。我一开始的想法是直接在组件的componentDidMount里直接$get拿数据，但是遇到了问题，首先是数据获取异步的问题，如果是$get，我url提交过去了，后台处理中，没等后台处理返回结果它就先返回了。这样的结果就是只渲染了父组件。render的时候调用this.state.data还是是undefined。在chrome里面调试的时候可以发现过了一会state里面才有内容。<br />
«««&lt; HEAD</p>

<h1 id="img1http7s1saycom1z0glbclouddncomreact11jpgimageview22w500h500q100watermark2textqnkg5li05rc054wn5b2xfont5a6l5l2tfontsize500fillizawrkzgrgdissolve100gravitysoutheastdx10dy10"><img src="http://img.haoqiao.me//react11.jpg?imageView2/2/w/500/h/500/q/100|watermark/2/text/Qnkg5Li05rC054Wn5b2x/font/5a6L5L2T/fontsize/500/fill/IzAwRkZGRg==/dissolve/100/gravity/SouthEast/dx/10/dy/10" alt="img1" /></h1>
<p><img src="http://img.haoqiao.me/react11.jpg?imageView2/2/w/500/h/500/q/100|watermark/2/text/Qnkg5Li05rC054Wn5b2x/font/5a6L5L2T/fontsize/500/fill/IzAwRkZGRg==/dissolve/100/gravity/SouthEast/dx/10/dy/10" alt="img1" /><br />
»»»&gt; 50e947e626468b25132932e5bef01ba0de58fb7c</p>

<p>遇到这种之前没接触过react问题，当然先是去群里吼一声，然后先天不聪大神直接给出两种解决方案</p>

<pre><code>1.使用$.ajax的async参数，配置async=false, 这个时候为同步请求，componentWillMount会等待ajax请求完成，你能成功的在componentWillMount中拿到data。后果就是，页面卡在这里，直到你拿到数据。
2.另外一种方式就是，给data一个默认值，第一次render让它画. 在componentDidMount函数里，$.get拿数据，拿到数据后setState会重新render，页面更新，总共2次render. 对于ajax的异步async设置为false这种方案我尝试无效后（可能是我写法有问题）我选择了第二种，先赋值，再setState。这种方案更加符合React的设计思路。在不同生命周期做不同的事情。首先是在 getInitialState 先赋值。这里提一句，由于我数据返回的是json，因此测试数据应该也是json格式的，虽然我后台拿到数据后生成的是一个数组，但是通过Json转换很容易拿到对应的格式。 在componentDidMount生命周期，也就是组件完成渲染后的周期我们去拿数据，这里我为啥不用get反而用Post呢？原因就是Node.js中，如果我用get，那么我route里面会这么写  /getdata/:url 
</code></pre>

<p>但是我们url里面当含有需要转义的字符比如  xxx.com/news ，这样我们就无法用req.params.url这种方式提取url，因此使用Post。当post拿到数据后我们发现有一句isMounted()的判断，从官网文档我们可以知道</p>

<pre><code> isMounted() returns true if the component is rendered into the DOM, false otherwise. You can use this method to guard asynchronous calls to setState() or forceUpdate().    当组件完成渲染后isMounted()返回true，这样我们setState改变state后自然而然就会重新渲染。细心的读者会发现渲染的时候子组件多了一个props key={Item.id} ，这是为了保证唯一性。如果想测试为什么的同学可以直接在刚开始赋值的时候把数据换成之后后台传过来的数据。
</code></pre>

<p>再来看newsitem.jsx，这里面的内容改动不大，只需要把href的值拿过来在render里就行，代码就不给出了，反正在github里我已经把所有源码传上去了。</p>

<h3 id="nodejs">Node.js后台处理</h3>

<p>对于后台数据的处理我们直接来看关键代码</p>

<pre><code>router.post('/getdata', function(req, res) {
var url = req.body.url;
console.log(url);
var data_result = new Array();
if(url == "toutiao.io"){
	superagent.get(url)
	    .end(function (err,response) {
	    	  if (err) {
         return next(err);
        }
	   
		 var $ = cheerio.load(response.text);
		// console.log(cheerio.load(res.text));
		$('.daily .posts .post .content .title a').each(function (idx, element) {
				    var $element = $(element);
				    var single = new Object();
				    
				    single.title = $element.text();
				    single.href = $element.attr('href');
				   // console.log("single.title content:"+single.title);
						data_result.push(single);
							//保存数据

		       });
	         res.send(JSON.stringify(data_result));
		       res.end();
 
	 });
 }
</code></pre>

<p>根据不同域名针对不同内容格式进行爬取，这个用到了几个模块，具体细节就不讲了。注意的是.end(function (err,response) 这句，官方给的示例是.end(function (err,res) ,会给后面res.send带来很大的麻烦，我调试了很久才发现这句有问题-0-，最后结果直接JSON.stringify转一下就能返回。<br />
### 测试<br />
代码写完了，我们可以来看下如何使用，我们直接在app.jsx里面写上</p>

<pre><code>React.render(
	&lt;NewsComponent component_style="green" item_style="info" url="toutiao.io"/&gt;,
	document.getElementById('example1')
);
React.render(
    &lt;NewsComponent component_style="blue" item_style="default" url="news.dbanotes.net/	    newest" /&gt;,
 document.getElementById('example2')
);
</code></pre>

<p>之后我们就可以看到正式运行后的界面。<br />
«««&lt; HEAD</p>

<table>
  <tbody>
    <tr>
      <td>![img2](http://img.haoqiao.me//react12.png?imageView2/2/w/500/h/500/q/100</td>
      <td>watermark/2/text/Qnkg5Li05rC054Wn5b2x/font/5a6L5L2T/fontsize/500/fill/IzAwRkZGRg==/dissolve/100/gravity/SouthEast/dx/10/dy/10)</td>
    </tr>
  </tbody>
</table>

<h1 id="img3http7s1saycom1z0glbclouddncomreact13pngimageview22w500h500q100watermark2textqnkg5li05rc054wn5b2xfont5a6l5l2tfontsize500fillizawrkzgrgdissolve100gravitysoutheastdx10dy10"><img src="http://img.haoqiao.me//react13.png?imageView2/2/w/500/h/500/q/100|watermark/2/text/Qnkg5Li05rC054Wn5b2x/font/5a6L5L2T/fontsize/500/fill/IzAwRkZGRg==/dissolve/100/gravity/SouthEast/dx/10/dy/10" alt="img3" /></h1>
<p><img src="http://img.haoqiao.me/react12.png?imageView2/2/w/500/h/500/q/100|watermark/2/text/Qnkg5Li05rC054Wn5b2x/font/5a6L5L2T/fontsize/500/fill/IzAwRkZGRg==/dissolve/100/gravity/SouthEast/dx/10/dy/10" alt="img2" /><br />
<img src="http://img.haoqiao.me/react13.png?imageView2/2/w/500/h/500/q/100|watermark/2/text/Qnkg5Li05rC054Wn5b2x/font/5a6L5L2T/fontsize/500/fill/IzAwRkZGRg==/dissolve/100/gravity/SouthEast/dx/10/dy/10" alt="img3" /></p>

<blockquote>
  <blockquote>
    <blockquote>
      <blockquote>
        <blockquote>
          <blockquote>
            <blockquote>
              <p>50e947e626468b25132932e5bef01ba0de58fb7c</p>
            </blockquote>
          </blockquote>
        </blockquote>
      </blockquote>
    </blockquote>
  </blockquote>
</blockquote>

<p>这样整个系统就算打通了，剩下就是部署了=-=，部署这块我还得继续学习，毕竟一入部署深似海，从此人品是路人。Ok，本次React三部曲也算结束了。有什么问题可以Email或者在博客里留言，不过我用的是社会评论插件，想在某个专题里凭论还需要重新在页面里刷新-0-下一个阶段我就算打算自己写一个外载的评论插件。应该会去学习一下vue.js然后配合React应用到下个项目中。本次项目已经传到了github上，有兴趣可以点 <a href="https://github.com/linshuizhaoying/news.haoqaio.me">这里</a>去fork或者clone。</p>

   <button><a href="http://comments.haoqiao.me/show/React从入门到上手三部曲(3)/haoqiao.me">跳到评论系统</a></button>


</article> <!-- end #post__content -->

<div id="post__share">
  <a id="icon-twitter" class="fontello" href="https://twitter.com/intent/tweet?url=http://linshuizhaoying.github.io/2015/08/11/react-three.html&text=React从入门到上手三部曲(3)" target="_blank"></a>
  <a id="icon-cc" class="fontello" href="http://creativecommons.org/licenses/by-nc-sa/3.0" target="_blank"></a>
  <a id="icon-weibo" class="fontello" href="http://v.t.sina.com.cn/share/share.php?url=http://linshuizhaoying.github.io/2015/08/11/react-three.html&title=React从入门到上手三部曲(3)" target="_blank"></a>
</div> <!-- end #post__share -->



        <p id="copyright">Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a>&nbsp;&nbsp;|&nbsp;&nbsp;Theme <a href="https://github.com/P233/3-Jekyll" target="_blank">3-Jekyll</a>&nbsp;&nbsp;|&nbsp;&nbsp;Hosted on <a href="https://pages.github.com" target="_blank">Github</a></p>
      </div> <!-- end #pjax -->

      <div id="post__toc-trigger">
        <div id="post__toc">
          <span id="post__toc-title">Table of Contents</span>
          <ul id="post__toc-ul"></ul>
        </div>
      </div>
    </div> <!-- end #post -->

    <button id="js-fullscreen"><span id="icon-arrow" class="fontello"></span></button>

<script src="/assets/js/jquery.js"></script>
<script src="/assets/js/jquery.pjax.js"></script>
<script src="/assets/js/nprogress.js"></script>
<script src="/assets/js/script.js"></script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-54767140-1', 'linshuizhaoying.github.io');
  ga('send', 'pageview');
</script>

  </body>
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1252932790'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/stat.php%3Fid%3D1252932790' type='text/javascript'%3E%3C/script%3E"));</script>
</html>